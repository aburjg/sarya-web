<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Playground</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
<style>
</style>
</head>
<body>

<div class="flex h-screen ">
<textarea id="input" class="w-6/12 resize-none border-r bg-gray-100 bg-gray-900 p-10 font-mono text-purple-200 text-sm focus:outline-none" placeholder="play([Res(Text('Hello World!'))])" wrap="off"
autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"></textarea>
<div class="w-6/12 flex flex-col h-screen"> 
<div class="h-3/4 bg-gray-50 overflow-y-auto">
<div class="fixed flex w-full items-center justify-start px-6 py-3 backdrop-blur-xl md:w-8/12">
<div class=" flex h-14 w-14 items-center justify-center rounded-full bg-white">
<img class="h-8" src="https://mj-cycls.github.io/sarya-web/img/logo.svg" />
</div>
<p class="opacity-0">.</p>
<p class="opacity-0">.</p>
<p class="opacity-0">.</p>
<img class="h-5" src="https://mj-cycls.github.io/sarya-web/img/sarya.svg"></img>
<p class="opacity-0">.</p>
<p class="opacity-0">.</p>
<p class="text-gray-500 text-md tracking-wide">╱ Playground</p>

</div>
<div class="h-5 bg-gradient-to-r from-pink-200 via-red-300 to-purple-300"></div>
<p class="opacity-0">.</p>
<p class="opacity-0">.</p>
<p class="opacity-0">.</p>
<p class="opacity-0">.</p>
<div id="responseArea"></div>
<p class="opacity-0">.</p>
<p class="opacity-0">.</p>
<p class="opacity-0">.</p>
<p class="opacity-0">.</p>
<p id="roll" class="opacity-0">.</p>
  
</div>
  
<textarea id="out" class="h-1/4 bg-gray-50 border-t bg-gray-100 font-mono text-gray-500 p-5 focus:outline-none resize-none"></textarea>
  
</div>
</div>

<script>
var area=document.getElementById('responseArea')

function timestamp(){var now=new Date();return now.toLocaleTimeString([],{hour:'numeric',minute:'2-digit'})}

function addToChat(x,type="text"){
let chatBubble=document.createElement('div');
var render=''
if(x.body.type==="text"){render=`<span>${x.body.text}<span>`}
else if(x.body.type==="image"){render=`<img class="image-roll w-auto max-w-md rounded-lg" src="${x.body.image}"/>`}
else{render=`<span>sorry, couldn't show<span>`}

chatBubble.innerHTML=
`<div class="flex items-start md:w-8/12 p-1 pl-4">
  <div class="p-2">
  ${x.dir==='req'?
     '<div class="h-8 w-8 rounded-full bg-gradient-to-r from-pink-300 to-purple-400"></div>':
     '<div class="h-8 w-8 rounded-full bg-gradient-to-r from-yellow-200 to-orange-400"></div>'}
  </div>
  <div class="rounded-2xl border border-gray-200 p-2">
    ${render}
    <p class="pt-2 text-right text-xs text-gray-400">${x.dir==='req'? '@you '+timestamp()+' ' : '@marid '+timestamp()+' ✓'}</p>
  </div>
</div>`;

area.appendChild(chatBubble);
}

function render(x){
x.forEach((x)=>{
if(x.dir==="req"){addToChat(x)}
if(x.dir==="res"){addToChat(x)}
})}

</script>

<script>
const input=document.getElementById("input");
var area=document.getElementById('responseArea')
var out=document.getElementById('out');

var elementToScrollTo = document.getElementById('roll')


async function main(){let x =await loadPyodide();
                      await x.loadPackage('micropip'); 
                      out.innerHTML="";
                      return x}
let pyth=main();

async function eval(){let x=await pyth;
try{
area.innerHTML='';out.innerHTML=''
// let result=x.runPython(`
let result=await x.runPythonAsync(`
import json
timeline=json.dumps([])

import pprint

def play(x,n=4):
 global timeline;pprint.pprint(x,width=50,depth=n,sort_dicts=False)
 a=json.dumps(x);timeline=a

def Req(x):
 if(len(x)>1):
  return {"dir":"req","body":x}
 return {"dir":"req","body":[x]}

def Res(x):
 if(len(x)>1):
  return {"dir":"res","body":x}
 return {"dir":"res","body":[x]}

def Text(x):
 return {"type":"text","text":x}

def Image(x):
 return {"type":"image","image":x}

${input.value}

timeline
`);
R=JSON.parse(result)
render(R)
//regular-roll
elementToScrollTo.scrollIntoView({behavior:'smooth',block:'nearest',inline:'start'})
// image-roll
var images=document.querySelectorAll('.image-roll'); // has to be here casue new images show every time!
images.forEach(function(image) {
image.addEventListener('load', function() {
elementToScrollTo.scrollIntoView({behavior:'smooth',block:'nearest',inline:'start'})
})
})
  
} 
catch(err){out.innerHTML=err}}
  
document.getElementById('input').addEventListener('input',function(){var x=this.value;
if(!this.value.startsWith('#slow')){eval(this.value)}})
  
document.addEventListener('keydown', event => {
if((event.metaKey || event.ctrlKey) && event.key === 'k'){eval()}})
  
</script>

<script>
var out=document.getElementById('out');
(function(){console.log=function(x){out.innerHTML+=x+'\n';out.scrollTop=out.scrollHeight}})()
</script>
</body>
</html>
